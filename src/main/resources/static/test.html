<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3U8 Video Player - Job-ID & Variant Based Architecture</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: white;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            font-weight: 300;
            background: linear-gradient(45deg, #fff, #e0e0e0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .architecture-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .architecture-info h2 {
            color: #4CAF50;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .architecture-info p {
            margin-bottom: 10px;
            line-height: 1.6;
            color: #e0e0e0;
        }

        .architecture-info .highlight {
            background: rgba(76, 175, 80, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            color: #4CAF50;
            font-weight: 500;
        }

        .input-section {
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        label {
            font-weight: 500;
            min-width: 120px;
            color: #e0e0e0;
        }

        input[type="text"] {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 16px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        input[type="text"]:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.3);
            border-color: #4CAF50;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
        }

        input[type="text"]::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .play-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            flex: 1;
            min-width: 120px;
        }

        .play-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
        }

        .play-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .clear-btn {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
            min-width: 100px;
        }

        .clear-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(244, 67, 54, 0.4);
        }

        .video-container {
            margin-top: 30px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            background: #000;
            position: relative;
        }

        video {
            width: 100%;
            height: auto;
            display: block;
            max-height: 70vh;
        }

        .video-info {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: #e0e0e0;
            flex-wrap: wrap;
            gap: 10px;
        }

        .status {
            padding: 10px 20px;
            margin: 15px 0;
            border-radius: 10px;
            font-weight: 500;
            text-align: center;
        }

        .status.loading {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.5);
            color: #ffc107;
        }

        .status.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.5);
            color: #f44336;
        }

        .status.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.5);
            color: #4CAF50;
        }

        .hidden {
            display: none;
        }

        .mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mode-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: transparent;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .mode-btn.active {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }

        .mode-btn:hover {
            border-color: #4CAF50;
        }

        .variant-input-group {
            display: none;
        }

        .variant-input-group.active {
            display: flex;
        }

        .example-inputs {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .example-inputs h3 {
            margin-bottom: 10px;
            color: #e0e0e0;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .example-item {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1);
            color: #4CAF50;
            padding: 5px 10px;
            margin: 3px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .example-item:hover {
            background: rgba(76, 175, 80, 0.2);
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }

            h1 {
                font-size: 2rem;
            }

            .input-group {
                flex-direction: column;
                align-items: stretch;
            }

            label {
                min-width: auto;
            }

            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üé¨ M3U8 Video Player - Job-ID & Variant Support</h1>

    <div class="architecture-info">
        <h2>üèóÔ∏è Job-ID with Optional Variant Loading</h2>
        <p>
            Load video streams using <span class="highlight">Job-ID</span> as master playlist or add a specific <span class="highlight">Variant</span> to load a variant playlist directly.
        </p>
        <p>
            <strong>Master Playlist:</strong> /api/v2/m3u8-encoder/proxy/{jobId}<br>
            <strong>Variant Playlist:</strong> /api/v2/m3u8-encoder/proxy/{jobId}/{variant}/index.m3u8
        </p>
    </div>

    <div class="input-section">
        <div class="mode-toggle">
            <button class="mode-btn active" onclick="switchMode('master')">Master Playlist</button>
            <button class="mode-btn" onclick="switchMode('variant')">Variant Playlist</button>
        </div>

        <div id="masterMode">
            <div class="input-group">
                <label for="jobIdInput">Job ID:</label>
                <input
                        type="text"
                        id="jobIdInput"
                        placeholder="Enter job ID (e.g., job-abc123)"
                        autocomplete="off"
                >
            </div>
        </div>

        <div id="variantMode" class="hidden">
            <div class="input-group">
                <label for="jobIdVariantInput">Job ID:</label>
                <input
                        type="text"
                        id="jobIdVariantInput"
                        placeholder="Enter job ID (e.g., job-abc123)"
                        autocomplete="off"
                >
            </div>
            <div class="input-group">
                <label for="variantInput">Variant:</label>
                <input
                        type="text"
                        id="variantInput"
                        placeholder="Enter variant (e.g., v0, 720p, high)"
                        autocomplete="off"
                >
            </div>
        </div>

        <div class="input-group">
            <label for="serverInput">Server URL:</label>
            <input
                    type="text"
                    id="serverInput"
                    placeholder="Server URL (default: http://localhost:8080)"
                    value="http://localhost:8080"
                    autocomplete="off"
            >
        </div>

        <div class="input-group">
            <label for="tokenInput">Bearer Token:</label>
            <input
                    type="text"
                    id="tokenInput"
                    placeholder="Enter Bearer Token (optional)"
                    autocomplete="off"
            >
        </div>

        <div class="button-group">
            <button class="play-btn" id="playBtn">‚ñ∂Ô∏è Load & Play</button>
            <button class="clear-btn" id="clearBtn">üóëÔ∏è Clear</button>
        </div>

        <div class="example-inputs">
            <h3>Quick Examples:</h3>
            <span class="example-item" onclick="setMasterExample()">Master: job-abc123</span>
            <span class="example-item" onclick="setVariantExample()">Variant: job-xyz / v0</span>
        </div>
    </div>

    <div id="status" class="status hidden"></div>

    <div id="videoContainer" class="video-container hidden">
        <video id="videoPlayer" controls preload="metadata">
            Your browser does not support the video tag.
        </video>
        <div class="video-info">
            <span id="videoUrl"></span>
            <span id="videoStatus"></span>
        </div>
    </div>
</div>

<script>
    let currentMode = 'master';

    function switchMode(mode) {
        currentMode = mode;
        document.getElementById('masterMode').classList.toggle('hidden', mode !== 'master');
        document.getElementById('variantMode').classList.toggle('hidden', mode !== 'variant');

        document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }

    function setMasterExample() {
        currentMode = 'master';
        document.getElementById('masterMode').classList.remove('hidden');
        document.getElementById('variantMode').classList.add('hidden');
        document.querySelectorAll('.mode-btn')[0].classList.add('active');
        document.querySelectorAll('.mode-btn')[1].classList.remove('active');
        document.getElementById('jobIdInput').value = 'job-abc123';
    }

    function setVariantExample() {
        currentMode = 'variant';
        document.getElementById('masterMode').classList.add('hidden');
        document.getElementById('variantMode').classList.remove('hidden');
        document.querySelectorAll('.mode-btn')[0].classList.remove('active');
        document.querySelectorAll('.mode-btn')[1].classList.add('active');
        document.getElementById('jobIdVariantInput').value = 'job-xyz';
        document.getElementById('variantInput').value = 'v0';
    }

    class M3U8Player {
        constructor() {
            this.video = document.getElementById('videoPlayer');
            this.jobIdInput = document.getElementById('jobIdInput');
            this.jobIdVariantInput = document.getElementById('jobIdVariantInput');
            this.variantInput = document.getElementById('variantInput');
            this.serverInput = document.getElementById('serverInput');
            this.tokenInput = document.getElementById('tokenInput');
            this.playBtn = document.getElementById('playBtn');
            this.clearBtn = document.getElementById('clearBtn');
            this.status = document.getElementById('status');
            this.videoContainer = document.getElementById('videoContainer');
            this.videoUrl = document.getElementById('videoUrl');
            this.videoStatus = document.getElementById('videoStatus');
            this.hls = null;

            this.initializeEventListeners();
            this.loadFromStorage();
        }

        initializeEventListeners() {
            this.playBtn.addEventListener('click', () => this.loadVideo());
            this.clearBtn.addEventListener('click', () => this.clearAll());

            [this.jobIdInput, this.jobIdVariantInput, this.variantInput, this.serverInput, this.tokenInput].forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.loadVideo();
                });
                input.addEventListener('input', () => this.saveToStorage());
            });

            this.video.addEventListener('loadstart', () => this.updateVideoStatus('Loading...'));
            this.video.addEventListener('loadedmetadata', () => {
                this.updateVideoStatus(`${this.video.videoWidth}x${this.video.videoHeight}`);
            });
            this.video.addEventListener('error', () => {
                this.showStatus('Video playback error occurred', 'error');
                this.updateVideoStatus('Error');
            });
            this.video.addEventListener('waiting', () => this.updateVideoStatus('Buffering...'));
            this.video.addEventListener('playing', () => this.updateVideoStatus('Playing'));
            this.video.addEventListener('pause', () => this.updateVideoStatus('Paused'));
        }

        saveToStorage() {
            localStorage.setItem('m3u8-player-jobid', this.jobIdInput.value);
            localStorage.setItem('m3u8-player-jobid-variant', this.jobIdVariantInput.value);
            localStorage.setItem('m3u8-player-variant', this.variantInput.value);
            localStorage.setItem('m3u8-player-server', this.serverInput.value);
            localStorage.setItem('m3u8-player-token', this.tokenInput.value);
            localStorage.setItem('m3u8-player-mode', currentMode);
        }

        loadFromStorage() {
            const mode = localStorage.getItem('m3u8-player-mode') || 'master';
            if (mode === 'variant') {
                switchMode('variant');
                this.jobIdVariantInput.value = localStorage.getItem('m3u8-player-jobid-variant') || '';
                this.variantInput.value = localStorage.getItem('m3u8-player-variant') || '';
            } else {
                this.jobIdInput.value = localStorage.getItem('m3u8-player-jobid') || '';
            }

            this.serverInput.value = localStorage.getItem('m3u8-player-server') || 'http://localhost:8080';
            this.tokenInput.value = localStorage.getItem('m3u8-player-token') || '';
        }

        async loadVideo() {
            const serverUrl = this.serverInput.value.trim();
            const token = this.tokenInput.value.trim();

            if (!serverUrl) {
                this.showStatus('Please enter a server URL', 'error');
                return;
            }

            let manifestUrl;

            if (currentMode === 'master') {
                const jobId = this.jobIdInput.value.trim();
                if (!jobId) {
                    this.showStatus('Please enter a job ID', 'error');
                    this.jobIdInput.focus();
                    return;
                }
                if (!jobId.startsWith('job-')) {
                    this.showStatus('Job ID must start with "job-"', 'error');
                    return;
                }
                manifestUrl = `${serverUrl}/api/v2/m3u8-encoder/proxy/${jobId}`;
            } else {
                const jobId = this.jobIdVariantInput.value.trim();
                const variant = this.variantInput.value.trim();

                if (!jobId || !variant) {
                    this.showStatus('Please enter both Job ID and Variant', 'error');
                    return;
                }
                if (!jobId.startsWith('job-')) {
                    this.showStatus('Job ID must start with "job-"', 'error');
                    return;
                }
                manifestUrl = `${serverUrl}/api/v2/m3u8-encoder/proxy/${jobId}/${variant}/index.m3u8`;
            }

            this.showStatus('Loading M3U8 manifest...', 'loading');
            this.playBtn.disabled = true;

            const fetchOptions = {};
            if (token) {
                fetchOptions.headers = { 'Authorization': `Bearer ${token}` };
            }

            try {
                const response = await fetch(manifestUrl, fetchOptions);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                this.loadHLSVideo(manifestUrl, token);

            } catch (error) {
                console.error('Error loading manifest:', error);
                this.showStatus(`Failed to load manifest: ${error.message}`, 'error');
                this.playBtn.disabled = false;
            }
        }

        loadHLSVideo(url, token) {
            if (this.hls) {
                this.hls.destroy();
                this.hls = null;
            }

            this.videoUrl.textContent = url;
            this.updateVideoStatus('Initializing...');

            if (Hls.isSupported()) {
                const hlsConfig = {
                    debug: true,
                    enableWorker: true,
                    lowLatencyMode: false,
                    backBufferLength: 90,
                    maxBufferSize: 60 * 1000 * 1000,
                    maxBufferLength: 30,
                    maxMaxBufferLength: 600
                };

                if (token) {
                    hlsConfig.xhrSetup = function (xhr, url) {
                        console.log('XHR Setup for:', url);
                        xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                    };
                }

                this.hls = new Hls(hlsConfig);

                // Enhanced error logging
                window.addEventListener('error', (e) => {
                    console.error('Global error:', e);
                });
                this.hls.loadSource(url);
                this.hls.attachMedia(this.video);

                this.hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    this.showStatus('Manifest loaded successfully! Ready to play.', 'success');
                    this.videoContainer.classList.remove('hidden');
                    this.playBtn.disabled = false;
                    this.video.play().catch(e => console.log('Auto-play prevented:', e.message));
                });

                this.hls.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        const msg = data.type === Hls.ErrorTypes.NETWORK_ERROR
                            ? 'Network error: Unable to load video'
                            : 'Error loading video';
                        this.showStatus(msg, 'error');
                        this.playBtn.disabled = false;
                    }
                });

            } else if (this.video.canPlayType('application/vnd.apple.mpegurl')) {
                this.video.src = url;
                this.video.addEventListener('loadedmetadata', () => {
                    this.showStatus('Manifest loaded successfully!', 'success');
                    this.videoContainer.classList.remove('hidden');
                    this.playBtn.disabled = false;
                });
                this.video.addEventListener('error', () => {
                    this.showStatus('Error loading video', 'error');
                    this.playBtn.disabled = false;
                });
            } else {
                this.showStatus('HLS is not supported in this browser', 'error');
                this.playBtn.disabled = false;
            }
        }

        clearAll() {
            this.jobIdInput.value = '';
            this.jobIdVariantInput.value = '';
            this.variantInput.value = '';
            this.serverInput.value = 'http://localhost:8080';
            this.tokenInput.value = '';

            localStorage.removeItem('m3u8-player-jobid');
            localStorage.removeItem('m3u8-player-jobid-variant');
            localStorage.removeItem('m3u8-player-variant');
            localStorage.removeItem('m3u8-player-server');
            localStorage.removeItem('m3u8-player-token');

            this.videoContainer.classList.add('hidden');
            this.status.classList.add('hidden');

            this.video.pause();
            this.video.src = '';

            if (this.hls) {
                this.hls.destroy();
                this.hls = null;
            }

            this.playBtn.disabled = false;
        }

        showStatus(message, type) {
            this.status.textContent = message;
            this.status.className = `status ${type}`;
            this.status.classList.remove('hidden');
        }

        updateVideoStatus(status) {
            this.videoStatus.textContent = status;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        new M3U8Player();
    });
</script>
</body>
</html>